---
# è¨­å®šé è¨­æª”æ¡ˆè·¯å¾‘ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
- name: è¨­å®šç‹€æ…‹æª”æ¡ˆè·¯å¾‘
  set_fact:
    status_file: "{{ status_file_path | default('/tmp/ansible_run_status.txt') }}"

- name: æª¢æŸ¥ä¸¦è¨˜éŒ„ unreachable ä¸»æ©Ÿ
  block:
    - name: å–å¾—æ‰€æœ‰æ‡‰è©²åŸ·è¡Œçš„ä¸»æ©Ÿ
      set_fact:
        expected_hosts: "{{ groups['all'] }}"
    
    - name: è®€å–å·²è¨˜éŒ„çš„ä¸»æ©Ÿ
      shell: "cat '{{ status_file }}' 2>/dev/null | cut -d'|' -f2 || echo ''"
      register: recorded_hosts_raw
      changed_when: false
      become: no

    - name: è§£æžå·²è¨˜éŒ„çš„ä¸»æ©Ÿæ¸…å–®
      set_fact:
        recorded_hosts: "{{ recorded_hosts_raw.stdout_lines }}"

    - name: æ‰¾å‡ºæœªè¨˜éŒ„çš„ä¸»æ©Ÿï¼ˆunreachableï¼‰
      set_fact:
        unreachable_hosts: "{{ expected_hosts | difference(recorded_hosts) }}"

    - name: å–å¾—æœ¬åœ°æ™‚é–“
      setup:
        filter: ansible_date_time
      delegate_to: localhost
      delegate_facts: true
      run_once: true
      when: unreachable_hosts | length > 0

    - name: ç‚º unreachable ä¸»æ©Ÿè£œå……è¨˜éŒ„
      lineinfile:
        path: "{{ status_file }}"
        line: "{{ hostvars['localhost']['ansible_date_time']['iso8601'] }}|{{ item }}|unreachable"
        create: yes
      loop: "{{ unreachable_hosts }}"
      when: unreachable_hosts | length > 0
      become: no
      throttle: 1

- name: è®€å–å®Œæ•´ç‹€æ…‹æª”æ¡ˆ
  shell: "cat '{{ status_file }}' 2>/dev/null || echo ''"
  register: status_content
  changed_when: false
  become: no

- name: è§£æžç‹€æ…‹
  set_fact:
    all_status: "{{ status_content.stdout_lines | map('split', '|') | list }}"
    
- name: åˆ†é¡žä¸»æ©Ÿ
  set_fact:
    success_hosts: "{{ all_status | selectattr('2', 'equalto', 'success') | list }}"
    failed_hosts: "{{ all_status | rejectattr('2', 'equalto', 'success') | list }}"

- name: å–å¾—æœ¬åœ°æ™‚é–“ç”¨æ–¼é€šçŸ¥
  setup:
    filter: ansible_date_time
  run_once: true

- name: Debug - æª¢æŸ¥åŸ·è¡Œç’°å¢ƒçš„æ™‚å€è¨­å®š
  shell: |
    echo "=== æ™‚å€è³‡è¨Š ==="
    echo "date å‘½ä»¤è¼¸å‡º: $(date '+%Y-%m-%d %H:%M:%S %Z')"
    echo "TZ ç’°å¢ƒè®Šæ•¸: ${TZ:-æœªè¨­å®š}"
    echo "ç³»çµ±æ™‚å€æª”: $(readlink -f /etc/localtime 2>/dev/null || echo 'ç„¡æ³•è®€å–')"
    echo "UTC æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S')"
    echo "==============="
  register: timezone_debug
  changed_when: false
  run_once: true

- name: Debug - é¡¯ç¤ºæ™‚å€è³‡è¨Š
  debug:
    msg: "{{ timezone_debug.stdout_lines }}"
  run_once: true

- name: å–å¾—æŒ‡å®šæ™‚å€çš„æœ¬åœ°æ™‚é–“
  shell: |
    TZ='{{ notification_timezone | default("Asia/Taipei") }}' date '+%Y-%m-%d %H:%M:%S %Z'
  register: local_datetime
  changed_when: false
  run_once: true

- name: Debug - é¡¯ç¤ºæ™‚é–“è³‡è¨Š
  debug:
    msg:
      - "åŽŸå§‹æ™‚é–“è¼¸å‡º: {{ local_datetime.stdout }}"
      - "é…ç½®çš„æ™‚å€: {{ notification_timezone | default('Asia/Taipei') }}"
  run_once: true

- name: è§£æžæœ¬åœ°æ™‚é–“
  set_fact:
    local_time_only: "{{ local_datetime.stdout.split()[1] }}"
    local_date: "{{ local_datetime.stdout.split()[0] }}"
    timezone_name: "{{ local_datetime.stdout.split()[2] if local_datetime.stdout.split() | length > 2 else '' }}"
  run_once: true

- name: Debug - é¡¯ç¤ºç‹€æ…‹è³‡è¨Š
  debug:
    msg:
      - "ç¸½ä¸»æ©Ÿæ•¸: {{ groups['all'] | length }}"
      - "è¨˜éŒ„ä¸»æ©Ÿæ•¸: {{ all_status | length }}"
      - "æˆåŠŸ: {{ success_hosts | length }}"
      - "å¤±æ•—: {{ failed_hosts | length }}"
      - "å¤±æ•—ä¸»æ©Ÿ: {{ failed_hosts | map(attribute='1') | list }}"

- name: ç™¼é€æˆåŠŸé€šçŸ¥
  uri:
    url: "{{ discord_webhook }}"
    method: POST
    body_format: json
    body:
      content: "âœ… **{{ notification_title }} ç³»çµ±æ›´æ–°å®Œæˆ**"
      embeds:
        - title: "Ansible åŸ·è¡ŒæˆåŠŸ"
          description: "æ‰€æœ‰ {{ groups['all'] | length }} å°ä¸»æ©Ÿå·²å®Œæˆç³»çµ±æ›´æ–°"
          color: 3066993
          fields:
            - name: "âœ… æˆåŠŸä¸»æ©Ÿ"
              value: "{{ success_hosts | length }} å°"
              inline: true
            - name: "â±ï¸ åŸ·è¡Œæ™‚é–“"
              value: "{{ local_time_only }}"
              inline: true
            - name: "ðŸ“… åŸ·è¡Œæ—¥æœŸ"
              value: "{{ local_date }}"
              inline: true
          footer:
            text: "ä»Šå¤© {{ local_time_only }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
    status_code: 204
  when: failed_hosts | length == 0
  become: no

- name: ç™¼é€å¤±æ•—é€šçŸ¥
  uri:
    url: "{{ discord_webhook }}"
    method: POST
    body_format: json
    body:
      content: "âŒ **{{ notification_title }} ç³»çµ±æ›´æ–°å¤±æ•—**"
      embeds:
        - title: "Ansible åŸ·è¡Œå¤±æ•—"
          description: |
            {% for host in failed_hosts %}
            {{ host[0] }} {{ host[1] }} **{{ host[2] }}**
            {% endfor %}
          color: 15158332
          footer:
            text: "ä»Šå¤© {{ local_time_only }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
    status_code: 204
  when: failed_hosts | length > 0
  become: no

- name: æ¸…ç†ç‹€æ…‹æª”æ¡ˆ
  file:
    path: "{{ status_file }}"
    state: absent
  become: no

- name: æ¨™è¨˜ä»»å‹™å¤±æ•—
  fail:
    msg: "{{ failed_hosts | length }} å°ä¸»æ©Ÿæ›´æ–°å¤±æ•—: {{ failed_hosts | map(attribute='1') | join(', ') }}"
  when: failed_hosts | length > 0