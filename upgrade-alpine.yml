- hosts: all
  become: yes
  become_user: root
  vars:
    discord_webhook: "{{ discord_webhook_url }}"
  
  tasks:
    - name: Update apk repo and cache on all Alpine boxes
      apk: update_cache=yes
      register: update_result
      ignore_errors: yes

    - name: Upgrade all packages on servers
      apk: upgrade=yes
      register: upgrade_result
      ignore_errors: yes

    # å°‡ç‹€æ…‹å¯«å…¥è‡¨æ™‚æª”æ¡ˆ
    - name: è¨˜éŒ„ä¸»æ©Ÿç‹€æ…‹
      copy:
        content: |
          {{ inventory_hostname }}|{{ ansible_host | default(inventory_hostname) }}|{{ 'failed' if (update_result.failed | default(false) or upgrade_result.failed | default(false)) else 'success' }}
        dest: "/tmp/ansible_status_{{ inventory_hostname }}.txt"
      delegate_to: localhost
      become: no

- hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    discord_webhook: "{{ discord_webhook_url }}"
  
  tasks:
    - name: è®€å–æ‰€æœ‰ä¸»æ©Ÿç‹€æ…‹æª”æ¡ˆ
      shell: "cat /tmp/ansible_status_*.txt 2>/dev/null || echo ''"
      register: all_status_raw
      changed_when: false
      become: no

    - name: è§£æžä¸»æ©Ÿç‹€æ…‹
      set_fact:
        all_hosts_parsed: "{{ all_status_raw.stdout_lines | map('split', '|') | list }}"

    - name: å»ºç«‹å¤±æ•—ä¸»æ©Ÿæ¸…å–®
      set_fact:
        failed_hosts_info: |
          {% set failed = [] %}
          {% for host_info in all_hosts_parsed %}
          {% if host_info | length == 3 and host_info[2] == 'failed' %}
          {% set _ = failed.append({'hostname': host_info[0], 'ip': host_info[1]}) %}
          {% endif %}
          {% endfor %}
          {{ failed }}

    - name: è½‰æ›ç‚ºæ¸…å–®æ ¼å¼
      set_fact:
        failed_hosts: "{{ failed_hosts_info | from_yaml }}"
        total_hosts: "{{ all_hosts_parsed | length }}"

    - name: è¨ˆç®—æˆåŠŸä¸»æ©Ÿæ•¸
      set_fact:
        success_count: "{{ total_hosts | int - failed_hosts | length }}"

    - name: ç™¼é€æˆåŠŸé€šçŸ¥
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body:
          content: "âœ… **Alpine ç³»çµ±æ›´æ–°å®Œæˆ**"
          embeds:
            - title: "Ansible åŸ·è¡ŒæˆåŠŸ"
              description: "æ‰€æœ‰ {{ total_hosts }} å°ä¸»æ©Ÿå·²å®Œæˆç³»çµ±æ›´æ–°"
              color: 3066993
              fields:
                - name: "âœ… æˆåŠŸä¸»æ©Ÿ"
                  value: "{{ success_count }} å°"
                  inline: true
                - name: "â±ï¸ åŸ·è¡Œæ™‚é–“"
                  value: "{{ ansible_date_time.time }}"
                  inline: true
                - name: "ðŸ“… åŸ·è¡Œæ—¥æœŸ"
                  value: "{{ ansible_date_time.date }}"
                  inline: true
              timestamp: "{{ ansible_date_time.iso8601 }}"
        status_code: 204
      when: failed_hosts | length == 0
      become: no

    - name: ç™¼é€å¤±æ•—é€šçŸ¥
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body:
          content: "@here âŒ **Alpine ç³»çµ±æ›´æ–°å¤±æ•—**"
          embeds:
            - title: "Ansible åŸ·è¡Œå¤±æ•—å ±å‘Š"
              description: "{{ failed_hosts | length }} å°ä¸»æ©Ÿåœ¨ç³»çµ±æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤"
              color: 15158332
              fields:
                - name: "ðŸ“Š åŸ·è¡Œçµ±è¨ˆ"
                  value: |
                    âœ… æˆåŠŸ: {{ success_count }} å°
                    âŒ å¤±æ•—: {{ failed_hosts | length }} å°
                    ðŸ“¦ ç¸½è¨ˆ: {{ total_hosts }} å°
                  inline: false
                - name: "âŒ å¤±æ•—ä¸»æ©Ÿæ¸…å–®"
                  value: |
                    {% for host in failed_hosts %}
                    â€¢ **{{ host.hostname }}** ({{ host.ip }})
                    {% endfor %}
                  inline: false
                - name: "â±ï¸ åŸ·è¡Œæ™‚é–“"
                  value: "{{ ansible_date_time.iso8601 }}"
                  inline: true
              timestamp: "{{ ansible_date_time.iso8601 }}"
        status_code: 204
      when: failed_hosts | length > 0
      become: no

    - name: æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
      file:
        path: "/tmp/ansible_status_{{ item }}.txt"
        state: absent
      loop: "{{ groups['all'] }}"
      become: no

    - name: å¦‚æžœæœ‰å¤±æ•—å‰‡æ¨™è¨˜ä»»å‹™å¤±æ•—
      fail:
        msg: "{{ failed_hosts | length }} å°ä¸»æ©Ÿæ›´æ–°å¤±æ•—"
      when: failed_hosts | length > 0