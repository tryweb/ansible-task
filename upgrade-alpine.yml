- hosts: all
  become: yes
  become_user: root
  vars:
    discord_webhook: "{{ discord_webhook_url }}"
  gather_facts: yes
  
  tasks:
    - name: Update apk repo and cache on all Alpine boxes
      apk: 
        update_cache: yes
      register: update_result
      ignore_unreachable: yes
      ignore_errors: yes

    - name: Upgrade all packages on servers
      apk: 
        upgrade: yes
      register: upgrade_result
      ignore_unreachable: yes
      ignore_errors: yes

    # åˆ¤æ–·ä¸»æ©Ÿç‹€æ…‹ï¼ˆç§»é™¤å¤šé¤˜ç©ºæ ¼ï¼‰
    - name: åˆ¤æ–·ä¸»æ©Ÿç‹€æ…‹
      set_fact:
        host_status: >-
          {% if update_result.unreachable is defined and update_result.unreachable %}unreachable{% elif upgrade_result.unreachable is defined and upgrade_result.unreachable %}unreachable{% elif update_result.failed is defined and update_result.failed %}failed{% elif upgrade_result.failed is defined and upgrade_result.failed %}failed{% else %}success{% endif %}

    # è¨˜éŒ„ç‹€æ…‹ï¼ˆæ³¨æ„ï¼šä½¿ç”¨ trim ç§»é™¤ç©ºæ ¼ï¼‰
    - name: è¨˜éŒ„ä¸»æ©Ÿç‹€æ…‹åˆ°æª”æ¡ˆ
      lineinfile:
        path: /tmp/ansible_run_status.txt
        line: "{{ ansible_date_time.iso8601 }}|{{ inventory_hostname }}|{{ host_status | trim }}"
        create: yes
      delegate_to: localhost
      become: no

- hosts: localhost
  connection: local
  gather_facts: yes
  vars:
    discord_webhook: "{{ discord_webhook_url }}"
  
  tasks:
    - name: æª¢æŸ¥ä¸¦è¨˜éŒ„ unreachable ä¸»æ©Ÿ
      block:
        - name: å–å¾—æ‰€æœ‰æ‡‰è©²åŸ·è¡Œçš„ä¸»æ©Ÿ
          set_fact:
            expected_hosts: "{{ groups['all'] }}"
        
        - name: è®€å–å·²è¨˜éŒ„çš„ä¸»æ©Ÿ
          shell: "cat /tmp/ansible_run_status.txt 2>/dev/null | cut -d'|' -f2 || echo ''"
          register: recorded_hosts_raw
          changed_when: false
          become: no

        - name: è§£æžå·²è¨˜éŒ„çš„ä¸»æ©Ÿæ¸…å–®
          set_fact:
            recorded_hosts: "{{ recorded_hosts_raw.stdout_lines }}"

        - name: æ‰¾å‡ºæœªè¨˜éŒ„çš„ä¸»æ©Ÿï¼ˆunreachableï¼‰
          set_fact:
            unreachable_hosts: "{{ expected_hosts | difference(recorded_hosts) }}"

        - name: ç‚º unreachable ä¸»æ©Ÿè£œå……è¨˜éŒ„
          lineinfile:
            path: /tmp/ansible_run_status.txt
            line: "{{ ansible_date_time.iso8601 }}|{{ item }}|unreachable"
            create: yes
          loop: "{{ unreachable_hosts }}"
          when: unreachable_hosts | length > 0
          become: no

    - name: è®€å–å®Œæ•´ç‹€æ…‹æª”æ¡ˆ
      shell: "cat /tmp/ansible_run_status.txt 2>/dev/null || echo ''"
      register: status_content
      changed_when: false
      become: no

    - name: è§£æžç‹€æ…‹
      set_fact:
        all_status: "{{ status_content.stdout_lines | map('split', '|') | list }}"
        
    - name: åˆ†é¡žä¸»æ©Ÿ
      set_fact:
        success_hosts: "{{ all_status | selectattr('2', 'equalto', 'success') | list }}"
        failed_hosts: "{{ all_status | rejectattr('2', 'equalto', 'success') | list }}"

    - name: Debug - é¡¯ç¤ºç‹€æ…‹è³‡è¨Š
      debug:
        msg:
          - "ç¸½ä¸»æ©Ÿæ•¸: {{ groups['all'] | length }}"
          - "è¨˜éŒ„ä¸»æ©Ÿæ•¸: {{ all_status | length }}"
          - "æˆåŠŸ: {{ success_hosts | length }}"
          - "å¤±æ•—: {{ failed_hosts | length }}"
          - "å¤±æ•—ä¸»æ©Ÿ: {{ failed_hosts | map(attribute='1') | list }}"

    - name: ç™¼é€æˆåŠŸé€šçŸ¥
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body:
          content: "âœ… **Alpine ç³»çµ±æ›´æ–°å®Œæˆ**"
          embeds:
            - title: "Ansible åŸ·è¡ŒæˆåŠŸ"
              description: "æ‰€æœ‰ {{ groups['all'] | length }} å°ä¸»æ©Ÿå·²å®Œæˆç³»çµ±æ›´æ–°"
              color: 3066993
              fields:
                - name: "âœ… æˆåŠŸä¸»æ©Ÿ"
                  value: "{{ success_hosts | length }} å°"
                  inline: true
                - name: "â±ï¸ åŸ·è¡Œæ™‚é–“"
                  value: "{{ ansible_date_time.time }}"
                  inline: true
                - name: "ðŸ“… åŸ·è¡Œæ—¥æœŸ"
                  value: "{{ ansible_date_time.date }}"
                  inline: true
              timestamp: "{{ ansible_date_time.iso8601 }}"
        status_code: 204
      when: failed_hosts | length == 0
      become: no

    - name: ç™¼é€å¤±æ•—é€šçŸ¥
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body:
          content: "âŒ **Alpine ç³»çµ±æ›´æ–°å¤±æ•—**"
          embeds:
            - title: "Ansible åŸ·è¡Œå¤±æ•—"
              description: |
                {% for host in failed_hosts %}
                {{ host[0] }} {{ host[1] }} **{{ host[2] }}**
                {% endfor %}
              color: 15158332
              timestamp: "{{ ansible_date_time.iso8601 }}"
        status_code: 204
      when: failed_hosts | length > 0
      become: no

    - name: æ¸…ç†ç‹€æ…‹æª”æ¡ˆ
      file:
        path: /tmp/ansible_run_status.txt
        state: absent
      become: no

    - name: æ¨™è¨˜ä»»å‹™å¤±æ•—
      fail:
        msg: "{{ failed_hosts | length }} å°ä¸»æ©Ÿæ›´æ–°å¤±æ•—: {{ failed_hosts | map(attribute='1') | join(', ') }}"
      when: failed_hosts | length > 0